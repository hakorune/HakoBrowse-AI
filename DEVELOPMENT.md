# HakoBrowseAI 開発履歴 / 現行仕様

## 現行仕様サマリ（2026-02-20時点）
- レイアウト: 左チャット / 右ブラウザ
- タブ機能: 新規、複製、閉じる、他タブを閉じる
- AI接続: Anthropic系 / OpenAI系 API（ストリーミング）
- ツール実行: ページ取得、遷移、URL取得、JS実行、ブックマーク操作
- エージェント設定: `SOUL.md` と `USER.md` を読込、UIから編集可能
- コンテキスト管理: 圧縮、SSOT管理、ツール結果の間引き
- セキュリティ: ツール/ページ内容を非信頼扱い、サニタイズ適用
- チャット履歴: 件数上限を設定可能（超過時に古い履歴を自動削除）
- Tool Trace: ツール呼び出しの実行ログをUIで確認可能
- Safety Gate: 危険操作前の確認ダイアログ
- セッション永続化: 終了後も会話/コンテキストを復元可能
- セッション保存戦略: イベント駆動 + 60秒フォールバック + ライフサイクル強制保存
- UI安定化: Chat復帰時の最下部スクロール維持、タブあふれ時の操作性を改善
- AI応答キャンセル: 応答中の送信ボタン再押下で中断可能
- チャット表示クリア: コンテキスト保持のまま表示だけリセット可能
- 入力補助: `/` 入力時にスラッシュコマンド候補を表示
- Popup policy: `allow` / `sameWindow` / `deny` をUIから切替可能
- デバッグ起動: `--default-state` で保存状態を読まずに初期状態プレビュー
- API設定: 未設定でもUI起動可能（後からSettingsで登録）
- デフォルトスキル: `Weather Check`(ON) / `Moltbook Post`(OFF)

## 主要マイルストーン

### 1) 基盤実装
- Flutter + `webview_windows` でブラウザUIを構築
- 左右2ペイン（チャット/ブラウザ）を実装

### 2) AI統合
- GLM/Anthropic系エンドポイントとOpenAI系エンドポイントに対応
- ストリーミング表示とFunction Callingを実装

### 3) ツール連携
- `get_page_content`
- `navigate_to`
- `get_current_url`
- `execute_script`
- `add_bookmark` / `list_bookmarks` / `open_bookmark`

### 4) ブラウザ強化
- タブUI導入
- ミドルクリックの新規タブ動作を追加
- URLバーにブックマークトグル導入

### 5) コンテキスト運用
- `ContextManager` 導入（SSOT、推定トークン、圧縮/剪定）
- `/compress` と `/clear` を実装

### 6) 注入耐性の強化
- ページ抽出結果のサニタイズ
- ツール結果全般のサニタイズ
- 「ツール出力は非信頼」の固定システムガードを追加

### 7) エージェントプロファイル
- `private/agent` / `private/agents/<name>` 構成に対応
- `SOUL.md` + `USER.md` を読み込み
- チャット画面から選択/再読込/編集保存が可能

### 8) 運用改善
- チャット履歴上限を設定化（デフォルト300件）
- 設定画面から `Chat max messages` を変更可能

### 9) 実行可視化と安全制御
- Tool Trace パネルを追加（引数・結果・所要時間・失敗理由）
- `navigate_to` / `execute_script` に Safety Gate を導入
- `extract_structured` ツールを追加（schemaベース抽出）

### 10) セッション保存/復元
- チャット履歴、Tool Trace、Agent Context、UI状態を自動保存
- 起動時に復元
- `/clear` で永続セッションも削除

### 11) UI操作性の改善
- Chatタブへ戻った際のスクロール位置を最下部へ安定化
- ブックマーク中クリックで新規タブを作成し前面表示
- タブバーにあふれ対策を追加（左右スクロール、ホイールスクロール、全タブ一覧）

### 12) 応答制御と入力体験
- AI応答中のキャンセル機能を追加（送信ボタンを停止ボタンへ切替）
- `/` 入力時のコマンド補完ヒントを追加
- Safety横に「チャット表示のみクリア（コンテキスト保持）」ボタンを追加

### 13) Popup運用改善
- Popup policy をAppBarから切替可能に変更（`allow` / `sameWindow` / `deny`）
- セッションにPopup policyを保存/復元
- Googleアカウント系ポップアップのクリック不整合に対し、AccountChooser同一タブ遷移フォールバックを追加

### 14) セッション保存とスキル運用の整備
- セッション保存を「イベント主導」に変更し、不要な連続保存を抑制
- dirty時のみ60秒フォールバック保存を実施
- アプリ非アクティブ化時の強制保存を追加
- 保存ログに reason を追加（どの契機で保存されたかを追跡可能）
- スキル本文は常時注入せず `load_skill_index` / `load_skill` の段階読込を基本運用化

### 15) デフォルト状態プレビューと初期導線改善
- `--default-state` 起動モードを追加（保存済み設定/セッションを読まず、永続化もしない）
- `--default-state` ではバンドル既定スキルを表示（`Weather Check` ON、`Moltbook Post` OFF）
- API未設定でもアプリ本体へ入れるように変更し、後からSettingsで登録できる導線に統一

## 現在の既知事項
- `execute_script` は強い権限なので将来的な制限が望ましい

## 次候補タスク
- [ ] `execute_script` の安全制限強化（許可ドメイン/ポリシー制御）
- [ ] エージェント単位の会話スレッド分離UI
- [ ] macOSでの実機検証
